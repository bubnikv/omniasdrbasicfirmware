C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE USBFS_DRV
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\USBFS_drv.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.3\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\Generated_Source\PSoC3\USBFS_drv.c NOIV LARGE MODDP2 OMF2 VB(1) NOIP INCDIR(.,Generated_Source\PSoC3) FF(3) DB DF(DEBU
                    -G) WL(2) PR(.\DP8051\DP8051_Keil_951\Debug/USBFS_drv.lst) CD OT(2,SIZE) OJ(.\DP8051\DP8051_Keil_951\Debug\USBFS_drv.obj)

line level    source

   1          /*******************************************************************************
   2          * File Name: USBFS_drv.c
   3          * Version 2.80
   4          *
   5          * Description:
   6          *  Endpoint 0 Driver for the USBFS Component.
   7          *
   8          * Note:
   9          *
  10          ********************************************************************************
  11          * Copyright 2008-2014, Cypress Semiconductor Corporation.  All rights reserved.
  12          * You may use this file only in accordance with the license, terms, conditions,
  13          * disclaimers, and limitations in the end user license agreement accompanying
  14          * the software package with which this file was provided.
  15          *******************************************************************************/
  16          
  17          #include "USBFS.h"
  18          #include "USBFS_pvt.h"
  19          
  20          
  21          
  22          /***************************************
  23          * Global data allocation
  24          ***************************************/
  25          
  26          volatile T_USBFS_EP_CTL_BLOCK USBFS_EP[USBFS_MAX_EP];
  27          volatile uint8 USBFS_configuration;
  28          volatile uint8 USBFS_interfaceNumber;
  29          volatile uint8 USBFS_configurationChanged;
  30          volatile uint8 USBFS_deviceAddress;
  31          volatile uint8 USBFS_deviceStatus;
  32          volatile uint8 USBFS_interfaceSetting[USBFS_MAX_INTERFACES_NUMBER];
  33          volatile uint8 USBFS_interfaceSetting_last[USBFS_MAX_INTERFACES_NUMBER];
  34          volatile uint8 USBFS_interfaceStatus[USBFS_MAX_INTERFACES_NUMBER];
  35          volatile uint8 USBFS_device;
  36          const uint8 CYCODE *USBFS_interfaceClass;
  37          
  38          
  39          /***************************************
  40          * Local data allocation
  41          ***************************************/
  42          
  43          volatile uint8 USBFS_ep0Toggle;
  44          volatile uint8 USBFS_lastPacketSize;
  45          volatile uint8 USBFS_transferState;
  46          volatile T_USBFS_TD USBFS_currentTD;
  47          volatile uint8 USBFS_ep0Mode;
  48          volatile uint8 USBFS_ep0Count;
  49          volatile uint16 USBFS_transferByteCount;
  50          
  51          
  52          /*******************************************************************************
  53          * Function Name: USBFS_ep_0_Interrupt
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 2   

  54          ********************************************************************************
  55          *
  56          * Summary:
  57          *  This Interrupt Service Routine handles Endpoint 0 (Control Pipe) traffic.
  58          *  It dispatches setup requests and handles the data and status stages.
  59          *
  60          * Parameters:
  61          *  None.
  62          *
  63          * Return:
  64          *  None.
  65          *
  66          *******************************************************************************/
  67          CY_ISR(USBFS_EP_0_ISR)
  68          {
  69   1          uint8 bRegTemp;
  70   1          uint8 modifyReg;
  71   1      
  72   1          #ifdef USBFS_EP_0_ISR_ENTRY_CALLBACK
                      USBFS_EP_0_ISR_EntryCallback();
                  #endif /* USBFS_EP_0_ISR_ENTRY_CALLBACK */
  75   1          
  76   1          bRegTemp = CY_GET_REG8(USBFS_EP0_CR_PTR);
  77   1          if ((bRegTemp & USBFS_MODE_ACKD) != 0u)
  78   1          {
  79   2              modifyReg = 1u;
  80   2              if ((bRegTemp & USBFS_MODE_SETUP_RCVD) != 0u)
  81   2              {
  82   3                  if((bRegTemp & USBFS_MODE_MASK) != USBFS_MODE_NAK_IN_OUT)
  83   3                  {
  84   4                      modifyReg = 0u;                                     /* When mode not NAK_IN_OUT => invalid
             - setup */
  85   4                  }
  86   3                  else
  87   3                  {
  88   4                      USBFS_HandleSetup();
  89   4                      if((USBFS_ep0Mode & USBFS_MODE_SETUP_RCVD) != 0u)
  90   4                      {
  91   5                          modifyReg = 0u;                         /* if SETUP bit set -> exit without modifying 
             -the mode */
  92   5                      }
  93   4      
  94   4                  }
  95   3              }
  96   2              else if ((bRegTemp & USBFS_MODE_IN_RCVD) != 0u)
  97   2              {
  98   3                  USBFS_HandleIN();
  99   3              }
 100   2              else if ((bRegTemp & USBFS_MODE_OUT_RCVD) != 0u)
 101   2              {
 102   3                  USBFS_HandleOUT();
 103   3              }
 104   2              else
 105   2              {
 106   3                  modifyReg = 0u;
 107   3              }
 108   2              if(modifyReg != 0u)
 109   2              {
 110   3                  bRegTemp = CY_GET_REG8(USBFS_EP0_CR_PTR);    /* unlock registers */
 111   3                  if((bRegTemp & USBFS_MODE_SETUP_RCVD) == 0u)  /* Check if SETUP bit is not set, otherwise exit
             - */
 112   3                  {
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 3   

 113   4                      /* Update the count register */
 114   4                      bRegTemp = USBFS_ep0Toggle | USBFS_ep0Count;
 115   4                      CY_SET_REG8(USBFS_EP0_CNT_PTR, bRegTemp);
 116   4                      if(bRegTemp == CY_GET_REG8(USBFS_EP0_CNT_PTR))   /* continue if writing was successful */
 117   4                      {
 118   5                          do
 119   5                          {
 120   6                              modifyReg = USBFS_ep0Mode;       /* Init temporary variable */
 121   6                              /* Unlock registers */
 122   6                              bRegTemp = CY_GET_REG8(USBFS_EP0_CR_PTR) & USBFS_MODE_SETUP_RCVD;
 123   6                              if(bRegTemp == 0u)                          /* Check if SETUP bit is not set */
 124   6                              {
 125   7                                  /* Set the Mode Register  */
 126   7                                  CY_SET_REG8(USBFS_EP0_CR_PTR, USBFS_ep0Mode);
 127   7                                  /* Writing check */
 128   7                                  modifyReg = CY_GET_REG8(USBFS_EP0_CR_PTR) & USBFS_MODE_MASK;
 129   7                              }
 130   6                          }while(modifyReg != USBFS_ep0Mode);  /* Repeat if writing was not successful */
 131   5                      }
 132   4                  }
 133   3              }
 134   2          }
 135   1          #ifdef USBFS_EP_0_ISR_EXIT_CALLBACK
                      USBFS_EP_0_ISR_ExitCallback();
                  #endif /* USBFS_EP_0_ISR_EXIT_CALLBACK */
 138   1      }
 139          
 140          
 141          /*******************************************************************************
 142          * Function Name: USBFS_HandleSetup
 143          ********************************************************************************
 144          *
 145          * Summary:
 146          *  This Routine dispatches requests for the four USB request types
 147          *
 148          * Parameters:
 149          *  None.
 150          *
 151          * Return:
 152          *  None.
 153          *
 154          * Reentrant:
 155          *  No.
 156          *
 157          *******************************************************************************/
 158          void USBFS_HandleSetup(void) 
 159          {
 160   1          uint8 requestHandled;
 161   1      
 162   1          requestHandled = CY_GET_REG8(USBFS_EP0_CR_PTR);      /* unlock registers */
 163   1          CY_SET_REG8(USBFS_EP0_CR_PTR, requestHandled);       /* clear setup bit */
 164   1          requestHandled = CY_GET_REG8(USBFS_EP0_CR_PTR);      /* reread register */
 165   1          if((requestHandled & USBFS_MODE_SETUP_RCVD) != 0u)
 166   1          {
 167   2              USBFS_ep0Mode = requestHandled;        /* if SETUP bit set -> exit without modifying the mode */
 168   2          }
 169   1          else
 170   1          {
 171   2              /* In case the previous transfer did not complete, close it out */
 172   2              USBFS_UpdateStatusBlock(USBFS_XFER_PREMATURE);
 173   2      
 174   2              switch (CY_GET_REG8(USBFS_bmRequestType) & USBFS_RQST_TYPE_MASK)
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 4   

 175   2              {
 176   3                  case USBFS_RQST_TYPE_STD:
 177   3                      requestHandled = USBFS_HandleStandardRqst();
 178   3                      break;
 179   3                  case USBFS_RQST_TYPE_CLS:
 180   3                      requestHandled = USBFS_DispatchClassRqst();
 181   3                      break;
 182   3                  case USBFS_RQST_TYPE_VND:
 183   3                      requestHandled = USBFS_HandleVendorRqst();
 184   3                      break;
 185   3                  default:
 186   3                      requestHandled = USBFS_FALSE;
 187   3                      break;
 188   3              }
 189   2              if (requestHandled == USBFS_FALSE)
 190   2              {
 191   3                  USBFS_ep0Mode = USBFS_MODE_STALL_IN_OUT;
 192   3              }
 193   2          }
 194   1      }
 195          
 196          
 197          /*******************************************************************************
 198          * Function Name: USBFS_HandleIN
 199          ********************************************************************************
 200          *
 201          * Summary:
 202          *  This routine handles EP0 IN transfers.
 203          *
 204          * Parameters:
 205          *  None.
 206          *
 207          * Return:
 208          *  None.
 209          *
 210          * Reentrant:
 211          *  No.
 212          *
 213          *******************************************************************************/
 214          void USBFS_HandleIN(void) 
 215          {
 216   1          switch (USBFS_transferState)
 217   1          {
 218   2              case USBFS_TRANS_STATE_IDLE:
 219   2                  break;
 220   2              case USBFS_TRANS_STATE_CONTROL_READ:
 221   2                  USBFS_ControlReadDataStage();
 222   2                  break;
 223   2              case USBFS_TRANS_STATE_CONTROL_WRITE:
 224   2                  USBFS_ControlWriteStatusStage();
 225   2                  break;
 226   2              case USBFS_TRANS_STATE_NO_DATA_CONTROL:
 227   2                  USBFS_NoDataControlStatusStage();
 228   2                  break;
 229   2              default:    /* there are no more states */
 230   2                  break;
 231   2          }
 232   1      }
 233          
 234          
 235          /*******************************************************************************
 236          * Function Name: USBFS_HandleOUT
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 5   

 237          ********************************************************************************
 238          *
 239          * Summary:
 240          *  This routine handles EP0 OUT transfers.
 241          *
 242          * Parameters:
 243          *  None.
 244          *
 245          * Return:
 246          *  None.
 247          *
 248          * Reentrant:
 249          *  No.
 250          *
 251          *******************************************************************************/
 252          void USBFS_HandleOUT(void) 
 253          {
 254   1          switch (USBFS_transferState)
 255   1          {
 256   2              case USBFS_TRANS_STATE_IDLE:
 257   2                  break;
 258   2              case USBFS_TRANS_STATE_CONTROL_READ:
 259   2                  USBFS_ControlReadStatusStage();
 260   2                  break;
 261   2              case USBFS_TRANS_STATE_CONTROL_WRITE:
 262   2                  USBFS_ControlWriteDataStage();
 263   2                  break;
 264   2              case USBFS_TRANS_STATE_NO_DATA_CONTROL:
 265   2                  /* Update the completion block */
 266   2                  USBFS_UpdateStatusBlock(USBFS_XFER_ERROR);
 267   2                  /* We expect no more data, so stall INs and OUTs */
 268   2                  USBFS_ep0Mode = USBFS_MODE_STALL_IN_OUT;
 269   2                  break;
 270   2              default:    /* There are no more states */
 271   2                  break;
 272   2          }
 273   1      }
 274          
 275          
 276          /*******************************************************************************
 277          * Function Name: USBFS_LoadEP0
 278          ********************************************************************************
 279          *
 280          * Summary:
 281          *  This routine loads the EP0 data registers for OUT transfers.  It uses the
 282          *  currentTD (previously initialized by the _InitControlWrite function and
 283          *  updated for each OUT transfer, and the bLastPacketSize) to determine how
 284          *  many uint8s to transfer on the current OUT.
 285          *
 286          *  If the number of uint8s remaining is zero and the last transfer was full,
 287          *  we need to send a zero length packet.  Otherwise we send the minimum
 288          *  of the control endpoint size (8) or remaining number of uint8s for the
 289          *  transaction.
 290          *
 291          * Parameters:
 292          *  None.
 293          *
 294          * Return:
 295          *  None.
 296          *
 297          * Global variables:
 298          *  USBFS_transferByteCount - Update the transfer byte count from the
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 6   

 299          *     last transaction.
 300          *  USBFS_ep0Count - counts the data loaded to the SIE memory in
 301          *     current packet.
 302          *  USBFS_lastPacketSize - remembers the USBFS_ep0Count value for the
 303          *     next packet.
 304          *  USBFS_transferByteCount - sum of the previous bytes transferred
 305          *     on previous packets(sum of USBFS_lastPacketSize)
 306          *  USBFS_ep0Toggle - inverted
 307          *  USBFS_ep0Mode  - prepare for mode register content.
 308          *  USBFS_transferState - set to TRANS_STATE_CONTROL_READ
 309          *
 310          * Reentrant:
 311          *  No.
 312          *
 313          *******************************************************************************/
 314          void USBFS_LoadEP0(void) 
 315          {
 316   1          uint8 ep0Count = 0u;
 317   1      
 318   1          /* Update the transfer byte count from the last transaction */
 319   1          USBFS_transferByteCount += USBFS_lastPacketSize;
 320   1          /* Now load the next transaction */
 321   1          while ((USBFS_currentTD.count > 0u) && (ep0Count < 8u))
 322   1          {
 323   2              CY_SET_REG8((reg8 *)(USBFS_EP0_DR0_IND + ep0Count), *USBFS_currentTD.pData);
 324   2              USBFS_currentTD.pData = &USBFS_currentTD.pData[1u];
 325   2              ep0Count++;
 326   2              USBFS_currentTD.count--;
 327   2          }
 328   1          /* Support zero-length packet*/
 329   1          if( (USBFS_lastPacketSize == 8u) || (ep0Count > 0u) )
 330   1          {
 331   2              /* Update the data toggle */
 332   2              USBFS_ep0Toggle ^= USBFS_EP0_CNT_DATA_TOGGLE;
 333   2              /* Set the Mode Register  */
 334   2              USBFS_ep0Mode = USBFS_MODE_ACK_IN_STATUS_OUT;
 335   2              /* Update the state (or stay the same) */
 336   2              USBFS_transferState = USBFS_TRANS_STATE_CONTROL_READ;
 337   2          }
 338   1          else
 339   1          {
 340   2              /* Expect Status Stage Out */
 341   2              USBFS_ep0Mode = USBFS_MODE_STATUS_OUT_ONLY;
 342   2              /* Update the state (or stay the same) */
 343   2              USBFS_transferState = USBFS_TRANS_STATE_CONTROL_READ;
 344   2          }
 345   1      
 346   1          /* Save the packet size for next time */
 347   1          USBFS_lastPacketSize = ep0Count;
 348   1          USBFS_ep0Count = ep0Count;
 349   1      }
 350          
 351          
 352          /*******************************************************************************
 353          * Function Name: USBFS_InitControlRead
 354          ********************************************************************************
 355          *
 356          * Summary:
 357          *  Initialize a control read transaction, usable to send data to the host.
 358          *  The following global variables should be initialized before this function
 359          *  called. To send zero length packet use InitZeroLengthControlTransfer
 360          *  function.
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 7   

 361          *
 362          * Parameters:
 363          *  None.
 364          *
 365          * Return:
 366          *  requestHandled state.
 367          *
 368          * Global variables:
 369          *  USBFS_currentTD.count - counts of data to be sent.
 370          *  USBFS_currentTD.pData - data pointer.
 371          *
 372          * Reentrant:
 373          *  No.
 374          *
 375          *******************************************************************************/
 376          uint8 USBFS_InitControlRead(void) 
 377          {
 378   1          uint16 xferCount;
 379   1          if(USBFS_currentTD.count == 0u)
 380   1          {
 381   2              (void) USBFS_InitZeroLengthControlTransfer();
 382   2          }
 383   1          else
 384   1          {
 385   2              /* Set up the state machine */
 386   2              USBFS_transferState = USBFS_TRANS_STATE_CONTROL_READ;
 387   2              /* Set the toggle, it gets updated in LoadEP */
 388   2              USBFS_ep0Toggle = 0u;
 389   2              /* Initialize the Status Block */
 390   2              USBFS_InitializeStatusBlock();
 391   2              xferCount = (((uint16)CY_GET_REG8(USBFS_lengthHi) << 8u) | (CY_GET_REG8(USBFS_lengthLo)));
 392   2      
 393   2              if (USBFS_currentTD.count > xferCount)
 394   2              {
 395   3                  USBFS_currentTD.count = xferCount;
 396   3              }
 397   2              USBFS_LoadEP0();
 398   2          }
 399   1      
 400   1          return(USBFS_TRUE);
 401   1      }
 402          
 403          
 404          /*******************************************************************************
 405          * Function Name: USBFS_InitZeroLengthControlTransfer
 406          ********************************************************************************
 407          *
 408          * Summary:
 409          *  Initialize a zero length data IN transfer.
 410          *
 411          * Parameters:
 412          *  None.
 413          *
 414          * Return:
 415          *  requestHandled state.
 416          *
 417          * Global variables:
 418          *  USBFS_ep0Toggle - set to EP0_CNT_DATA_TOGGLE
 419          *  USBFS_ep0Mode  - prepare for mode register content.
 420          *  USBFS_transferState - set to TRANS_STATE_CONTROL_READ
 421          *  USBFS_ep0Count - cleared, means the zero-length packet.
 422          *  USBFS_lastPacketSize - cleared.
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 8   

 423          *
 424          * Reentrant:
 425          *  No.
 426          *
 427          *******************************************************************************/
 428          uint8 USBFS_InitZeroLengthControlTransfer(void)
 429                                                          
 430          {
 431   1          /* Update the state */
 432   1          USBFS_transferState = USBFS_TRANS_STATE_CONTROL_READ;
 433   1          /* Set the data toggle */
 434   1          USBFS_ep0Toggle = USBFS_EP0_CNT_DATA_TOGGLE;
 435   1          /* Set the Mode Register  */
 436   1          USBFS_ep0Mode = USBFS_MODE_ACK_IN_STATUS_OUT;
 437   1          /* Save the packet size for next time */
 438   1          USBFS_lastPacketSize = 0u;
 439   1          USBFS_ep0Count = 0u;
 440   1      
 441   1          return(USBFS_TRUE);
 442   1      }
 443          
 444          
 445          /*******************************************************************************
 446          * Function Name: USBFS_ControlReadDataStage
 447          ********************************************************************************
 448          *
 449          * Summary:
 450          *  Handle the Data Stage of a control read transfer.
 451          *
 452          * Parameters:
 453          *  None.
 454          *
 455          * Return:
 456          *  None.
 457          *
 458          * Reentrant:
 459          *  No.
 460          *
 461          *******************************************************************************/
 462          void USBFS_ControlReadDataStage(void) 
 463          
 464          {
 465   1          USBFS_LoadEP0();
 466   1      }
 467          
 468          
 469          /*******************************************************************************
 470          * Function Name: USBFS_ControlReadStatusStage
 471          ********************************************************************************
 472          *
 473          * Summary:
 474          *  Handle the Status Stage of a control read transfer.
 475          *
 476          * Parameters:
 477          *  None.
 478          *
 479          * Return:
 480          *  None.
 481          *
 482          * Global variables:
 483          *  USBFS_USBFS_transferByteCount - updated with last packet size.
 484          *  USBFS_transferState - set to TRANS_STATE_IDLE.
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 9   

 485          *  USBFS_ep0Mode  - set to MODE_STALL_IN_OUT.
 486          *
 487          * Reentrant:
 488          *  No.
 489          *
 490          *******************************************************************************/
 491          void USBFS_ControlReadStatusStage(void) 
 492          {
 493   1          /* Update the transfer byte count */
 494   1          USBFS_transferByteCount += USBFS_lastPacketSize;
 495   1          /* Go Idle */
 496   1          USBFS_transferState = USBFS_TRANS_STATE_IDLE;
 497   1          /* Update the completion block */
 498   1          USBFS_UpdateStatusBlock(USBFS_XFER_STATUS_ACK);
 499   1          /* We expect no more data, so stall INs and OUTs */
 500   1          USBFS_ep0Mode =  USBFS_MODE_STALL_IN_OUT;
 501   1      }
 502          
 503          
 504          /*******************************************************************************
 505          * Function Name: USBFS_InitControlWrite
 506          ********************************************************************************
 507          *
 508          * Summary:
 509          *  Initialize a control write transaction
 510          *
 511          * Parameters:
 512          *  None.
 513          *
 514          * Return:
 515          *  requestHandled state.
 516          *
 517          * Global variables:
 518          *  USBFS_USBFS_transferState - set to TRANS_STATE_CONTROL_WRITE
 519          *  USBFS_ep0Toggle - set to EP0_CNT_DATA_TOGGLE
 520          *  USBFS_ep0Mode  - set to MODE_ACK_OUT_STATUS_IN
 521          *
 522          * Reentrant:
 523          *  No.
 524          *
 525          *******************************************************************************/
 526          uint8 USBFS_InitControlWrite(void) 
 527          {
 528   1          uint16 xferCount;
 529   1      
 530   1          /* Set up the state machine */
 531   1          USBFS_transferState = USBFS_TRANS_STATE_CONTROL_WRITE;
 532   1          /* This might not be necessary */
 533   1          USBFS_ep0Toggle = USBFS_EP0_CNT_DATA_TOGGLE;
 534   1          /* Initialize the Status Block */
 535   1          USBFS_InitializeStatusBlock();
 536   1      
 537   1          xferCount = (((uint16)CY_GET_REG8(USBFS_lengthHi) << 8u) | (CY_GET_REG8(USBFS_lengthLo)));
 538   1      
 539   1          if (USBFS_currentTD.count > xferCount)
 540   1          {
 541   2              USBFS_currentTD.count = xferCount;
 542   2          }
 543   1      
 544   1          /* Expect Data or Status Stage */
 545   1          USBFS_ep0Mode = USBFS_MODE_ACK_OUT_STATUS_IN;
 546   1      
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 10  

 547   1          return(USBFS_TRUE);
 548   1      }
 549          
 550          
 551          /*******************************************************************************
 552          * Function Name: USBFS_ControlWriteDataStage
 553          ********************************************************************************
 554          *
 555          * Summary:
 556          *  Handle the Data Stage of a control write transfer
 557          *       1. Get the data (We assume the destination was validated previously)
 558          *       2. Update the count and data toggle
 559          *       3. Update the mode register for the next transaction
 560          *
 561          * Parameters:
 562          *  None.
 563          *
 564          * Return:
 565          *  None.
 566          *
 567          * Global variables:
 568          *  USBFS_transferByteCount - Update the transfer byte count from the
 569          *    last transaction.
 570          *  USBFS_ep0Count - counts the data loaded from the SIE memory
 571          *    in current packet.
 572          *  USBFS_transferByteCount - sum of the previous bytes transferred
 573          *    on previous packets(sum of USBFS_lastPacketSize)
 574          *  USBFS_ep0Toggle - inverted
 575          *  USBFS_ep0Mode  - set to MODE_ACK_OUT_STATUS_IN.
 576          *
 577          * Reentrant:
 578          *  No.
 579          *
 580          *******************************************************************************/
 581          void USBFS_ControlWriteDataStage(void) 
 582          {
 583   1          uint8 ep0Count;
 584   1          uint8 regIndex = 0u;
 585   1      
 586   1          ep0Count = (CY_GET_REG8(USBFS_EP0_CNT_PTR) & USBFS_EPX_CNT0_MASK) -
 587   1                     USBFS_EPX_CNTX_CRC_COUNT;
 588   1      
 589   1          USBFS_transferByteCount += ep0Count;
 590   1      
 591   1          while ((USBFS_currentTD.count > 0u) && (ep0Count > 0u))
 592   1          {
 593   2              *USBFS_currentTD.pData = CY_GET_REG8((reg8 *)(USBFS_EP0_DR0_IND + regIndex));
 594   2              USBFS_currentTD.pData = &USBFS_currentTD.pData[1u];
 595   2              regIndex++;
 596   2              ep0Count--;
 597   2              USBFS_currentTD.count--;
 598   2          }
 599   1          USBFS_ep0Count = ep0Count;
 600   1          /* Update the data toggle */
 601   1          USBFS_ep0Toggle ^= USBFS_EP0_CNT_DATA_TOGGLE;
 602   1          /* Expect Data or Status Stage */
 603   1          USBFS_ep0Mode = USBFS_MODE_ACK_OUT_STATUS_IN;
 604   1      }
 605          
 606          
 607          /*******************************************************************************
 608          * Function Name: USBFS_ControlWriteStatusStage
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 11  

 609          ********************************************************************************
 610          *
 611          * Summary:
 612          *  Handle the Status Stage of a control write transfer
 613          *
 614          * Parameters:
 615          *  None.
 616          *
 617          * Return:
 618          *  None.
 619          *
 620          * Global variables:
 621          *  USBFS_transferState - set to TRANS_STATE_IDLE.
 622          *  USBFS_USBFS_ep0Mode  - set to MODE_STALL_IN_OUT.
 623          *
 624          * Reentrant:
 625          *  No.
 626          *
 627          *******************************************************************************/
 628          void USBFS_ControlWriteStatusStage(void) 
 629          {
 630   1          /* Go Idle */
 631   1          USBFS_transferState = USBFS_TRANS_STATE_IDLE;
 632   1          /* Update the completion block */
 633   1          USBFS_UpdateStatusBlock(USBFS_XFER_STATUS_ACK);
 634   1          /* We expect no more data, so stall INs and OUTs */
 635   1          USBFS_ep0Mode = USBFS_MODE_STALL_IN_OUT;
 636   1      }
 637          
 638          
 639          /*******************************************************************************
 640          * Function Name: USBFS_InitNoDataControlTransfer
 641          ********************************************************************************
 642          *
 643          * Summary:
 644          *  Initialize a no data control transfer
 645          *
 646          * Parameters:
 647          *  None.
 648          *
 649          * Return:
 650          *  requestHandled state.
 651          *
 652          * Global variables:
 653          *  USBFS_transferState - set to TRANS_STATE_NO_DATA_CONTROL.
 654          *  USBFS_ep0Mode  - set to MODE_STATUS_IN_ONLY.
 655          *  USBFS_ep0Count - cleared.
 656          *  USBFS_ep0Toggle - set to EP0_CNT_DATA_TOGGLE
 657          *
 658          * Reentrant:
 659          *  No.
 660          *
 661          *******************************************************************************/
 662          uint8 USBFS_InitNoDataControlTransfer(void) 
 663          {
 664   1          USBFS_transferState = USBFS_TRANS_STATE_NO_DATA_CONTROL;
 665   1          USBFS_ep0Mode = USBFS_MODE_STATUS_IN_ONLY;
 666   1          USBFS_ep0Toggle = USBFS_EP0_CNT_DATA_TOGGLE;
 667   1          USBFS_ep0Count = 0u;
 668   1      
 669   1          return(USBFS_TRUE);
 670   1      }
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 12  

 671          
 672          
 673          /*******************************************************************************
 674          * Function Name: USBFS_NoDataControlStatusStage
 675          ********************************************************************************
 676          * Summary:
 677          *  Handle the Status Stage of a no data control transfer.
 678          *
 679          *  SET_ADDRESS is special, since we need to receive the status stage with
 680          *  the old address.
 681          *
 682          * Parameters:
 683          *  None.
 684          *
 685          * Return:
 686          *  None.
 687          *
 688          * Global variables:
 689          *  USBFS_transferState - set to TRANS_STATE_IDLE.
 690          *  USBFS_ep0Mode  - set to MODE_STALL_IN_OUT.
 691          *  USBFS_ep0Toggle - set to EP0_CNT_DATA_TOGGLE
 692          *  USBFS_deviceAddress - used to set new address and cleared
 693          *
 694          * Reentrant:
 695          *  No.
 696          *
 697          *******************************************************************************/
 698          void USBFS_NoDataControlStatusStage(void) 
 699          {
 700   1          /* Change the USB address register if we got a SET_ADDRESS. */
 701   1          if (USBFS_deviceAddress != 0u)
 702   1          {
 703   2              CY_SET_REG8(USBFS_CR0_PTR, USBFS_deviceAddress | USBFS_CR0_ENABLE);
 704   2              USBFS_deviceAddress = 0u;
 705   2          }
 706   1          /* Go Idle */
 707   1          USBFS_transferState = USBFS_TRANS_STATE_IDLE;
 708   1          /* Update the completion block */
 709   1          USBFS_UpdateStatusBlock(USBFS_XFER_STATUS_ACK);
 710   1           /* We expect no more data, so stall INs and OUTs */
 711   1          USBFS_ep0Mode = USBFS_MODE_STALL_IN_OUT;
 712   1      }
 713          
 714          
 715          /*******************************************************************************
 716          * Function Name: USBFS_UpdateStatusBlock
 717          ********************************************************************************
 718          *
 719          * Summary:
 720          *  Update the Completion Status Block for a Request.  The block is updated
 721          *  with the completion code the USBFS_transferByteCount.  The
 722          *  StatusBlock Pointer is set to NULL.
 723          *
 724          * Parameters:
 725          *  completionCode - status.
 726          *
 727          * Return:
 728          *  None.
 729          *
 730          * Global variables:
 731          *  USBFS_currentTD.pStatusBlock->status - updated by the
 732          *    completionCode parameter.
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 13  

 733          *  USBFS_currentTD.pStatusBlock->length - updated.
 734          *  USBFS_currentTD.pStatusBlock - cleared.
 735          *
 736          * Reentrant:
 737          *  No.
 738          *
 739          *******************************************************************************/
 740          void USBFS_UpdateStatusBlock(uint8 completionCode) 
 741          {
 742   1          if (USBFS_currentTD.pStatusBlock != NULL)
 743   1          {
 744   2              USBFS_currentTD.pStatusBlock->status = completionCode;
 745   2              USBFS_currentTD.pStatusBlock->length = USBFS_transferByteCount;
 746   2              USBFS_currentTD.pStatusBlock = NULL;
 747   2          }
 748   1      }
 749          
 750          
 751          /*******************************************************************************
 752          * Function Name: USBFS_InitializeStatusBlock
 753          ********************************************************************************
 754          *
 755          * Summary:
 756          *  Initialize the Completion Status Block for a Request.  The completion
 757          *  code is set to USB_XFER_IDLE.
 758          *
 759          *  Also, initializes USBFS_transferByteCount.  Save some space,
 760          *  this is the only consumer.
 761          *
 762          * Parameters:
 763          *  None.
 764          *
 765          * Return:
 766          *  None.
 767          *
 768          * Global variables:
 769          *  USBFS_currentTD.pStatusBlock->status - set to XFER_IDLE.
 770          *  USBFS_currentTD.pStatusBlock->length - cleared.
 771          *  USBFS_transferByteCount - cleared.
 772          *
 773          * Reentrant:
 774          *  No.
 775          *
 776          *******************************************************************************/
 777          void USBFS_InitializeStatusBlock(void) 
 778          {
 779   1          USBFS_transferByteCount = 0u;
 780   1          if(USBFS_currentTD.pStatusBlock != NULL)
 781   1          {
 782   2              USBFS_currentTD.pStatusBlock->status = USBFS_XFER_IDLE;
 783   2              USBFS_currentTD.pStatusBlock->length = 0u;
 784   2          }
 785   1      }
 786          
 787          
 788          /* [] END OF FILE */
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 14  

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION USBFS_EP_0_ISR (BEGIN)
0000 C0E0              PUSH    ACC
0002 C0F0              PUSH    B
0004 C083              PUSH    DPH
0006 C082              PUSH    DPL
0008 C085              PUSH    DPH1
000A C084              PUSH    DPL1
000C C086              PUSH    DPS
000E 758600            MOV     DPS,#00H
0011 C000        E     PUSH    ?C?XPAGE1SFR
0013 750000      E     MOV     ?C?XPAGE1SFR,#?C?XPAGE1RST
0016 C0D0              PUSH    PSW
0018 75D000            MOV     PSW,#00H
001B C000              PUSH    AR0
001D C001              PUSH    AR1
001F C002              PUSH    AR2
0021 C003              PUSH    AR3
0023 C004              PUSH    AR4
0025 C005              PUSH    AR5
0027 C006              PUSH    AR6
0029 C007              PUSH    AR7
                                           ; SOURCE LINE # 67
                                           ; SOURCE LINE # 76
002B 906028            MOV     DPTR,#06028H
002E E0                MOVX    A,@DPTR
002F FF                MOV     R7,A
0030 900000      R     MOV     DPTR,#bRegTemp
0033 EF                MOV     A,R7
0034 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 77
0035 900000      R     MOV     DPTR,#bRegTemp
0038 E0                MOVX    A,@DPTR
0039 FF                MOV     R7,A
003A EF                MOV     A,R7
003B 5410              ANL     A,#010H
003D FF                MOV     R7,A
003E 7E00              MOV     R6,#00H
0040 EF                MOV     A,R7
0041 4E                ORL     A,R6
0042 7003              JNZ     $ + 5H
0044 020000      R     LJMP    ?C0018
                                           ; SOURCE LINE # 78
                                           ; SOURCE LINE # 79
0047 900000      R     MOV     DPTR,#modifyReg
004A 7401              MOV     A,#01H
004C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 80
004D 900000      R     MOV     DPTR,#bRegTemp
0050 E0                MOVX    A,@DPTR
0051 FF                MOV     R7,A
0052 EF                MOV     A,R7
0053 5480              ANL     A,#080H
0055 FF                MOV     R7,A
0056 7E00              MOV     R6,#00H
0058 EF                MOV     A,R7
0059 4E                ORL     A,R6
005A 6031              JZ      ?C0002
                                           ; SOURCE LINE # 81
                                           ; SOURCE LINE # 82
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 15  

005C 900000      R     MOV     DPTR,#bRegTemp
005F E0                MOVX    A,@DPTR
0060 FF                MOV     R7,A
0061 EF                MOV     A,R7
0062 540F              ANL     A,#0FH
0064 FF                MOV     R7,A
0065 7E00              MOV     R6,#00H
0067 EF                MOV     A,R7
0068 6401              XRL     A,#01H
006A 4E                ORL     A,R6
006B 6007              JZ      ?C0003
                                           ; SOURCE LINE # 83
                                           ; SOURCE LINE # 84
006D 900000      R     MOV     DPTR,#modifyReg
0070 E4                CLR     A
0071 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 85
0072 8046              SJMP    ?C0006
0074         ?C0003:
                                           ; SOURCE LINE # 87
                                           ; SOURCE LINE # 88
0074 120000      R     LCALL   USBFS_HandleSetup
                                           ; SOURCE LINE # 89
0077 900000      R     MOV     DPTR,#USBFS_ep0Mode
007A E0                MOVX    A,@DPTR
007B FF                MOV     R7,A
007C EF                MOV     A,R7
007D 5480              ANL     A,#080H
007F FF                MOV     R7,A
0080 7E00              MOV     R6,#00H
0082 EF                MOV     A,R7
0083 4E                ORL     A,R6
0084 6034              JZ      ?C0006
                                           ; SOURCE LINE # 90
                                           ; SOURCE LINE # 91
0086 900000      R     MOV     DPTR,#modifyReg
0089 E4                CLR     A
008A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 92
                                           ; SOURCE LINE # 94
                                           ; SOURCE LINE # 95
008B 802D              SJMP    ?C0006
008D         ?C0002:
                                           ; SOURCE LINE # 96
008D 900000      R     MOV     DPTR,#bRegTemp
0090 E0                MOVX    A,@DPTR
0091 FF                MOV     R7,A
0092 EF                MOV     A,R7
0093 5440              ANL     A,#040H
0095 FF                MOV     R7,A
0096 7E00              MOV     R6,#00H
0098 EF                MOV     A,R7
0099 4E                ORL     A,R6
009A 6005              JZ      ?C0007
                                           ; SOURCE LINE # 97
                                           ; SOURCE LINE # 98
009C 120000      R     LCALL   USBFS_HandleIN
                                           ; SOURCE LINE # 99
009F 8019              SJMP    ?C0006
00A1         ?C0007:
                                           ; SOURCE LINE # 100
00A1 900000      R     MOV     DPTR,#bRegTemp
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 16  

00A4 E0                MOVX    A,@DPTR
00A5 FF                MOV     R7,A
00A6 EF                MOV     A,R7
00A7 5420              ANL     A,#020H
00A9 FF                MOV     R7,A
00AA 7E00              MOV     R6,#00H
00AC EF                MOV     A,R7
00AD 4E                ORL     A,R6
00AE 6005              JZ      ?C0009
                                           ; SOURCE LINE # 101
                                           ; SOURCE LINE # 102
00B0 120000      R     LCALL   USBFS_HandleOUT
                                           ; SOURCE LINE # 103
00B3 8005              SJMP    ?C0006
00B5         ?C0009:
                                           ; SOURCE LINE # 105
                                           ; SOURCE LINE # 106
00B5 900000      R     MOV     DPTR,#modifyReg
00B8 E4                CLR     A
00B9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 107
00BA         ?C0006:
                                           ; SOURCE LINE # 108
00BA 900000      R     MOV     DPTR,#modifyReg
00BD E0                MOVX    A,@DPTR
00BE FF                MOV     R7,A
00BF EF                MOV     A,R7
00C0 7003              JNZ     $ + 5H
00C2 020000      R     LJMP    ?C0018
                                           ; SOURCE LINE # 109
                                           ; SOURCE LINE # 110
00C5 906028            MOV     DPTR,#06028H
00C8 E0                MOVX    A,@DPTR
00C9 FF                MOV     R7,A
00CA 900000      R     MOV     DPTR,#bRegTemp
00CD EF                MOV     A,R7
00CE F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 111
00CF 900000      R     MOV     DPTR,#bRegTemp
00D2 E0                MOVX    A,@DPTR
00D3 FF                MOV     R7,A
00D4 EF                MOV     A,R7
00D5 5480              ANL     A,#080H
00D7 FF                MOV     R7,A
00D8 7E00              MOV     R6,#00H
00DA EF                MOV     A,R7
00DB 4E                ORL     A,R6
00DC 7070              JNZ     ?C0018
                                           ; SOURCE LINE # 112
                                           ; SOURCE LINE # 114
00DE 900000      R     MOV     DPTR,#USBFS_ep0Count
00E1 E0                MOVX    A,@DPTR
00E2 FF                MOV     R7,A
00E3 900000      R     MOV     DPTR,#USBFS_ep0Toggle
00E6 E0                MOVX    A,@DPTR
00E7 FE                MOV     R6,A
00E8 EE                MOV     A,R6
00E9 4F                ORL     A,R7
00EA FF                MOV     R7,A
00EB 900000      R     MOV     DPTR,#bRegTemp
00EE EF                MOV     A,R7
00EF F0                MOVX    @DPTR,A
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 17  

                                           ; SOURCE LINE # 115
00F0 900000      R     MOV     DPTR,#bRegTemp
00F3 E0                MOVX    A,@DPTR
00F4 FF                MOV     R7,A
00F5 906029            MOV     DPTR,#06029H
00F8 EF                MOV     A,R7
00F9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 116
00FA 906029            MOV     DPTR,#06029H
00FD E0                MOVX    A,@DPTR
00FE FF                MOV     R7,A
00FF 900000      R     MOV     DPTR,#bRegTemp
0102 E0                MOVX    A,@DPTR
0103 FE                MOV     R6,A
0104 EE                MOV     A,R6
0105 6F                XRL     A,R7
0106 7046              JNZ     ?C0018
                                           ; SOURCE LINE # 117
0108         ?C0016:
                                           ; SOURCE LINE # 119
                                           ; SOURCE LINE # 120
0108 900000      R     MOV     DPTR,#USBFS_ep0Mode
010B E0                MOVX    A,@DPTR
010C FF                MOV     R7,A
010D 900000      R     MOV     DPTR,#modifyReg
0110 EF                MOV     A,R7
0111 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 122
0112 906028            MOV     DPTR,#06028H
0115 E0                MOVX    A,@DPTR
0116 FF                MOV     R7,A
0117 EF                MOV     A,R7
0118 5480              ANL     A,#080H
011A FF                MOV     R7,A
011B 900000      R     MOV     DPTR,#bRegTemp
011E EF                MOV     A,R7
011F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 123
0120 900000      R     MOV     DPTR,#bRegTemp
0123 E0                MOVX    A,@DPTR
0124 FF                MOV     R7,A
0125 EF                MOV     A,R7
0126 7018              JNZ     ?C0014
                                           ; SOURCE LINE # 124
                                           ; SOURCE LINE # 126
0128 900000      R     MOV     DPTR,#USBFS_ep0Mode
012B E0                MOVX    A,@DPTR
012C FF                MOV     R7,A
012D 906028            MOV     DPTR,#06028H
0130 EF                MOV     A,R7
0131 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 128
0132 906028            MOV     DPTR,#06028H
0135 E0                MOVX    A,@DPTR
0136 FF                MOV     R7,A
0137 EF                MOV     A,R7
0138 540F              ANL     A,#0FH
013A FF                MOV     R7,A
013B 900000      R     MOV     DPTR,#modifyReg
013E EF                MOV     A,R7
013F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 129
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 18  

                                           ; SOURCE LINE # 130
0140         ?C0014:
0140 900000      R     MOV     DPTR,#USBFS_ep0Mode
0143 E0                MOVX    A,@DPTR
0144 FF                MOV     R7,A
0145 900000      R     MOV     DPTR,#modifyReg
0148 E0                MOVX    A,@DPTR
0149 FE                MOV     R6,A
014A EE                MOV     A,R6
014B B507BA            CJNE    A,AR7,?C0016
                                           ; SOURCE LINE # 131
                                           ; SOURCE LINE # 132
                                           ; SOURCE LINE # 133
                                           ; SOURCE LINE # 134
                                           ; SOURCE LINE # 138
014E         ?C0018:
014E D007              POP     AR7
0150 D006              POP     AR6
0152 D005              POP     AR5
0154 D004              POP     AR4
0156 D003              POP     AR3
0158 D002              POP     AR2
015A D001              POP     AR1
015C D000              POP     AR0
015E D0D0              POP     PSW
0160 D000        E     POP     ?C?XPAGE1SFR
0162 D086              POP     DPS
0164 D084              POP     DPL1
0166 D085              POP     DPH1
0168 D082              POP     DPL
016A D083              POP     DPH
016C D0F0              POP     B
016E D0E0              POP     ACC
0170 32                RETI    
             ; FUNCTION USBFS_EP_0_ISR (END)

             ; FUNCTION USBFS_HandleSetup (BEGIN)
                                           ; SOURCE LINE # 158
                                           ; SOURCE LINE # 159
                                           ; SOURCE LINE # 162
0000 906028            MOV     DPTR,#06028H
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
0005 900000      R     MOV     DPTR,#requestHandled
0008 EF                MOV     A,R7
0009 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 163
000A 900000      R     MOV     DPTR,#requestHandled
000D E0                MOVX    A,@DPTR
000E FF                MOV     R7,A
000F 906028            MOV     DPTR,#06028H
0012 EF                MOV     A,R7
0013 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 164
0014 906028            MOV     DPTR,#06028H
0017 E0                MOVX    A,@DPTR
0018 FF                MOV     R7,A
0019 900000      R     MOV     DPTR,#requestHandled
001C EF                MOV     A,R7
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 165
001E 900000      R     MOV     DPTR,#requestHandled
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 19  

0021 E0                MOVX    A,@DPTR
0022 FF                MOV     R7,A
0023 EF                MOV     A,R7
0024 5480              ANL     A,#080H
0026 FF                MOV     R7,A
0027 7E00              MOV     R6,#00H
0029 EF                MOV     A,R7
002A 4E                ORL     A,R6
002B 600B              JZ      ?C0019
                                           ; SOURCE LINE # 166
                                           ; SOURCE LINE # 167
002D 900000      R     MOV     DPTR,#requestHandled
0030 E0                MOVX    A,@DPTR
0031 FF                MOV     R7,A
0032 900000      R     MOV     DPTR,#USBFS_ep0Mode
0035 EF                MOV     A,R7
0036 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 168
0037 22                RET     
0038         ?C0019:
                                           ; SOURCE LINE # 170
                                           ; SOURCE LINE # 172
0038 7F02              MOV     R7,#02H
003A 120000      R     LCALL   _USBFS_UpdateStatusBlock
                                           ; SOURCE LINE # 174
003D 906000            MOV     DPTR,#06000H
0040 E0                MOVX    A,@DPTR
0041 FF                MOV     R7,A
0042 EF                MOV     A,R7
0043 5460              ANL     A,#060H
0045 FF                MOV     R7,A
0046 EF                MOV     A,R7
0047 120000      E     LCALL   ?C?CCASE
004A 0000        R     DW      ?C0022
004C 00                DB      00H
004D 0000        R     DW      ?C0023
004F 20                DB      020H
0050 0000        R     DW      ?C0024
0052 40                DB      040H
0053 0000              DW      00H
0055 0000        R     DW      ?C0025
                                           ; SOURCE LINE # 175
                                           ; SOURCE LINE # 176
0057         ?C0022:
                                           ; SOURCE LINE # 177
0057 120000      E     LCALL   USBFS_HandleStandardRqst
005A 900000      R     MOV     DPTR,#requestHandled
005D EF                MOV     A,R7
005E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 178
005F 8019              SJMP    ?C0021
                                           ; SOURCE LINE # 179
0061         ?C0023:
                                           ; SOURCE LINE # 180
0061 120000      E     LCALL   USBFS_DispatchClassRqst
0064 900000      R     MOV     DPTR,#requestHandled
0067 EF                MOV     A,R7
0068 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 181
0069 800F              SJMP    ?C0021
                                           ; SOURCE LINE # 182
006B         ?C0024:
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 20  

                                           ; SOURCE LINE # 183
006B 120000      E     LCALL   USBFS_HandleVendorRqst
006E 900000      R     MOV     DPTR,#requestHandled
0071 EF                MOV     A,R7
0072 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 184
0073 8005              SJMP    ?C0021
                                           ; SOURCE LINE # 185
0075         ?C0025:
                                           ; SOURCE LINE # 186
0075 900000      R     MOV     DPTR,#requestHandled
0078 E4                CLR     A
0079 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 187
                                           ; SOURCE LINE # 188
007A         ?C0021:
                                           ; SOURCE LINE # 189
007A 900000      R     MOV     DPTR,#requestHandled
007D E0                MOVX    A,@DPTR
007E FF                MOV     R7,A
007F EF                MOV     A,R7
0080 7006              JNZ     ?C0027
                                           ; SOURCE LINE # 190
                                           ; SOURCE LINE # 191
0082 900000      R     MOV     DPTR,#USBFS_ep0Mode
0085 7403              MOV     A,#03H
0087 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 192
                                           ; SOURCE LINE # 193
                                           ; SOURCE LINE # 194
0088         ?C0027:
0088 22                RET     
             ; FUNCTION USBFS_HandleSetup (END)

             ; FUNCTION USBFS_HandleIN (BEGIN)
                                           ; SOURCE LINE # 214
                                           ; SOURCE LINE # 215
                                           ; SOURCE LINE # 216
0000 900000      R     MOV     DPTR,#USBFS_transferState
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
0005 EF                MOV     A,R7
0006 120000      E     LCALL   ?C?CCASE
0009 0000        R     DW      ?C0034
000B 00                DB      00H
000C 0000        R     DW      ?C0030
000E 02                DB      02H
000F 0000        R     DW      ?C0031
0011 04                DB      04H
0012 0000        R     DW      ?C0032
0014 06                DB      06H
0015 0000              DW      00H
0017 0000        R     DW      ?C0034
                                           ; SOURCE LINE # 217
                                           ; SOURCE LINE # 218
                                           ; SOURCE LINE # 219
                                           ; SOURCE LINE # 220
0019         ?C0030:
                                           ; SOURCE LINE # 221
0019 120000      R     LCALL   USBFS_ControlReadDataStage
                                           ; SOURCE LINE # 222
001C 22                RET     
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 21  

                                           ; SOURCE LINE # 223
001D         ?C0031:
                                           ; SOURCE LINE # 224
001D 120000      R     LCALL   USBFS_ControlWriteStatusStage
                                           ; SOURCE LINE # 225
0020 22                RET     
                                           ; SOURCE LINE # 226
0021         ?C0032:
                                           ; SOURCE LINE # 227
0021 120000      R     LCALL   USBFS_NoDataControlStatusStage
                                           ; SOURCE LINE # 228
                                           ; SOURCE LINE # 229
                                           ; SOURCE LINE # 230
                                           ; SOURCE LINE # 231
                                           ; SOURCE LINE # 232
0024         ?C0034:
0024 22                RET     
             ; FUNCTION USBFS_HandleIN (END)

             ; FUNCTION USBFS_HandleOUT (BEGIN)
                                           ; SOURCE LINE # 252
                                           ; SOURCE LINE # 253
                                           ; SOURCE LINE # 254
0000 900000      R     MOV     DPTR,#USBFS_transferState
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
0005 EF                MOV     A,R7
0006 120000      E     LCALL   ?C?CCASE
0009 0000        R     DW      ?C0041
000B 00                DB      00H
000C 0000        R     DW      ?C0037
000E 02                DB      02H
000F 0000        R     DW      ?C0038
0011 04                DB      04H
0012 0000        R     DW      ?C0039
0014 06                DB      06H
0015 0000              DW      00H
0017 0000        R     DW      ?C0041
                                           ; SOURCE LINE # 255
                                           ; SOURCE LINE # 256
                                           ; SOURCE LINE # 257
                                           ; SOURCE LINE # 258
0019         ?C0037:
                                           ; SOURCE LINE # 259
0019 120000      R     LCALL   USBFS_ControlReadStatusStage
                                           ; SOURCE LINE # 260
001C 22                RET     
                                           ; SOURCE LINE # 261
001D         ?C0038:
                                           ; SOURCE LINE # 262
001D 120000      R     LCALL   USBFS_ControlWriteDataStage
                                           ; SOURCE LINE # 263
0020 22                RET     
                                           ; SOURCE LINE # 264
0021         ?C0039:
                                           ; SOURCE LINE # 266
0021 7F03              MOV     R7,#03H
0023 120000      R     LCALL   _USBFS_UpdateStatusBlock
                                           ; SOURCE LINE # 268
0026 900000      R     MOV     DPTR,#USBFS_ep0Mode
0029 7403              MOV     A,#03H
002B F0                MOVX    @DPTR,A
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 22  

                                           ; SOURCE LINE # 269
                                           ; SOURCE LINE # 270
                                           ; SOURCE LINE # 271
                                           ; SOURCE LINE # 272
                                           ; SOURCE LINE # 273
002C         ?C0041:
002C 22                RET     
             ; FUNCTION USBFS_HandleOUT (END)

             ; FUNCTION USBFS_LoadEP0 (BEGIN)
                                           ; SOURCE LINE # 314
                                           ; SOURCE LINE # 315
                                           ; SOURCE LINE # 316
0000 900000      R     MOV     DPTR,#ep0Count
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 319
0005 900000      R     MOV     DPTR,#USBFS_lastPacketSize
0008 E0                MOVX    A,@DPTR
0009 FF                MOV     R7,A
000A 7E00              MOV     R6,#00H
000C 900000      R     MOV     DPTR,#USBFS_transferByteCount
000F EE                MOV     A,R6
0010 8FF0              MOV     B,R7
0012 120000      E     LCALL   ?C?IILDX
0015         ?C0042:
                                           ; SOURCE LINE # 321
0015 900000      R     MOV     DPTR,#USBFS_currentTD
0018 E0                MOVX    A,@DPTR
0019 FE                MOV     R6,A
001A A3                INC     DPTR
001B E0                MOVX    A,@DPTR
001C FF                MOV     R7,A
001D D3                SETB    C
001E EF                MOV     A,R7
001F 9400              SUBB    A,#00H
0021 EE                MOV     A,R6
0022 9400              SUBB    A,#00H
0024 4053              JC      ?C0043
0026 900000      R     MOV     DPTR,#ep0Count
0029 E0                MOVX    A,@DPTR
002A FF                MOV     R7,A
002B EF                MOV     A,R7
002C C3                CLR     C
002D 9408              SUBB    A,#08H
002F 5048              JNC     ?C0043
                                           ; SOURCE LINE # 322
                                           ; SOURCE LINE # 323
0031 900000      R     MOV     DPTR,#USBFS_currentTD+02H
0034 120000      E     LCALL   ?C?PLDXDATA
0037 120000      E     LCALL   ?C?CLDPTR
003A FF                MOV     R7,A
003B 900000      R     MOV     DPTR,#ep0Count
003E E0                MOVX    A,@DPTR
003F FE                MOV     R6,A
0040 EE                MOV     A,R6
0041 FD                MOV     R5,A
0042 7C00              MOV     R4,#00H
0044 ED                MOV     A,R5
0045 2400              ADD     A,#00H
0047 FD                MOV     R5,A
0048 EC                MOV     A,R4
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 23  

0049 3460              ADDC    A,#060H
004B FC                MOV     R4,A
004C 8D82              MOV     DPL,R5
004E 8C83              MOV     DPH,R4
0050 EF                MOV     A,R7
0051 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 324
0052 900000      R     MOV     DPTR,#USBFS_currentTD+02H
0055 120000      E     LCALL   ?C?PLDXDATA
0058 E9                MOV     A,R1
0059 2401              ADD     A,#01H
005B F9                MOV     R1,A
005C EA                MOV     A,R2
005D 3400              ADDC    A,#00H
005F FA                MOV     R2,A
0060 900000      R     MOV     DPTR,#USBFS_currentTD+02H
0063 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 325
0066 900000      R     MOV     DPTR,#ep0Count
0069 E0                MOVX    A,@DPTR
006A 04                INC     A
006B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 326
006C 900000      R     MOV     DPTR,#USBFS_currentTD
006F 74FF              MOV     A,#0FFH
0071 75F0FF            MOV     B,#0FFH
0074 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 327
0077 809C              SJMP    ?C0042
0079         ?C0043:
                                           ; SOURCE LINE # 329
0079 900000      R     MOV     DPTR,#USBFS_lastPacketSize
007C E0                MOVX    A,@DPTR
007D FF                MOV     R7,A
007E EF                MOV     A,R7
007F 6408              XRL     A,#08H
0081 600B              JZ      ?C0045
0083 900000      R     MOV     DPTR,#ep0Count
0086 E0                MOVX    A,@DPTR
0087 FF                MOV     R7,A
0088 EF                MOV     A,R7
0089 D3                SETB    C
008A 9400              SUBB    A,#00H
008C 401C              JC      ?C0044
008E         ?C0045:
                                           ; SOURCE LINE # 330
                                           ; SOURCE LINE # 332
008E 900000      R     MOV     DPTR,#USBFS_ep0Toggle
0091 E0                MOVX    A,@DPTR
0092 FF                MOV     R7,A
0093 EF                MOV     A,R7
0094 6480              XRL     A,#080H
0096 FF                MOV     R7,A
0097 900000      R     MOV     DPTR,#USBFS_ep0Toggle
009A EF                MOV     A,R7
009B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 334
009C 900000      R     MOV     DPTR,#USBFS_ep0Mode
009F 740F              MOV     A,#0FH
00A1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 336
00A2 900000      R     MOV     DPTR,#USBFS_transferState
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 24  

00A5 7402              MOV     A,#02H
00A7 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 337
00A8 800C              SJMP    ?C0046
00AA         ?C0044:
                                           ; SOURCE LINE # 339
                                           ; SOURCE LINE # 341
00AA 900000      R     MOV     DPTR,#USBFS_ep0Mode
00AD 7402              MOV     A,#02H
00AF F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 343
00B0 900000      R     MOV     DPTR,#USBFS_transferState
00B3 7402              MOV     A,#02H
00B5 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 344
00B6         ?C0046:
                                           ; SOURCE LINE # 347
00B6 900000      R     MOV     DPTR,#ep0Count
00B9 E0                MOVX    A,@DPTR
00BA FF                MOV     R7,A
00BB 900000      R     MOV     DPTR,#USBFS_lastPacketSize
00BE EF                MOV     A,R7
00BF F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 348
00C0 900000      R     MOV     DPTR,#ep0Count
00C3 E0                MOVX    A,@DPTR
00C4 FF                MOV     R7,A
00C5 900000      R     MOV     DPTR,#USBFS_ep0Count
00C8 EF                MOV     A,R7
00C9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 349
00CA 22                RET     
             ; FUNCTION USBFS_LoadEP0 (END)

             ; FUNCTION USBFS_InitControlRead (BEGIN)
                                           ; SOURCE LINE # 376
                                           ; SOURCE LINE # 377
                                           ; SOURCE LINE # 379
0000 900000      R     MOV     DPTR,#USBFS_currentTD
0003 E0                MOVX    A,@DPTR
0004 FE                MOV     R6,A
0005 A3                INC     DPTR
0006 E0                MOVX    A,@DPTR
0007 FF                MOV     R7,A
0008 EF                MOV     A,R7
0009 4E                ORL     A,R6
000A 7005              JNZ     ?C0048
                                           ; SOURCE LINE # 380
                                           ; SOURCE LINE # 381
000C 120000      R     LCALL   USBFS_InitZeroLengthControlTransfer
                                           ; SOURCE LINE # 382
000F 8058              SJMP    ?C0049
0011         ?C0048:
                                           ; SOURCE LINE # 384
                                           ; SOURCE LINE # 386
0011 900000      R     MOV     DPTR,#USBFS_transferState
0014 7402              MOV     A,#02H
0016 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 388
0017 900000      R     MOV     DPTR,#USBFS_ep0Toggle
001A E4                CLR     A
001B F0                MOVX    @DPTR,A
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 25  

                                           ; SOURCE LINE # 390
001C 120000      R     LCALL   USBFS_InitializeStatusBlock
                                           ; SOURCE LINE # 391
001F 906007            MOV     DPTR,#06007H
0022 E0                MOVX    A,@DPTR
0023 FF                MOV     R7,A
0024 7E00              MOV     R6,#00H
0026 EF                MOV     A,R7
0027 7F00              MOV     R7,#00H
0029 FE                MOV     R6,A
002A 906006            MOV     DPTR,#06006H
002D E0                MOVX    A,@DPTR
002E FD                MOV     R5,A
002F 7C00              MOV     R4,#00H
0031 EE                MOV     A,R6
0032 4C                ORL     A,R4
0033 FE                MOV     R6,A
0034 EF                MOV     A,R7
0035 4D                ORL     A,R5
0036 FF                MOV     R7,A
0037 900000      R     MOV     DPTR,#xferCount
003A EE                MOV     A,R6
003B F0                MOVX    @DPTR,A
003C A3                INC     DPTR
003D EF                MOV     A,R7
003E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 393
003F 900000      R     MOV     DPTR,#xferCount
0042 E0                MOVX    A,@DPTR
0043 FE                MOV     R6,A
0044 A3                INC     DPTR
0045 E0                MOVX    A,@DPTR
0046 FF                MOV     R7,A
0047 900000      R     MOV     DPTR,#USBFS_currentTD
004A E0                MOVX    A,@DPTR
004B FC                MOV     R4,A
004C A3                INC     DPTR
004D E0                MOVX    A,@DPTR
004E FD                MOV     R5,A
004F D3                SETB    C
0050 ED                MOV     A,R5
0051 9F                SUBB    A,R7
0052 EC                MOV     A,R4
0053 9E                SUBB    A,R6
0054 4010              JC      ?C0050
                                           ; SOURCE LINE # 394
                                           ; SOURCE LINE # 395
0056 900000      R     MOV     DPTR,#xferCount
0059 E0                MOVX    A,@DPTR
005A FE                MOV     R6,A
005B A3                INC     DPTR
005C E0                MOVX    A,@DPTR
005D FF                MOV     R7,A
005E 900000      R     MOV     DPTR,#USBFS_currentTD
0061 EE                MOV     A,R6
0062 F0                MOVX    @DPTR,A
0063 A3                INC     DPTR
0064 EF                MOV     A,R7
0065 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 396
0066         ?C0050:
                                           ; SOURCE LINE # 397
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 26  

0066 120000      R     LCALL   USBFS_LoadEP0
                                           ; SOURCE LINE # 398
0069         ?C0049:
                                           ; SOURCE LINE # 400
0069 7F01              MOV     R7,#01H
                                           ; SOURCE LINE # 401
006B         ?C0051:
006B 22                RET     
             ; FUNCTION USBFS_InitControlRead (END)

             ; FUNCTION USBFS_InitZeroLengthControlTransfer (BEGIN)
                                           ; SOURCE LINE # 428
                                           ; SOURCE LINE # 430
                                           ; SOURCE LINE # 432
0000 900000      R     MOV     DPTR,#USBFS_transferState
0003 7402              MOV     A,#02H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 434
0006 900000      R     MOV     DPTR,#USBFS_ep0Toggle
0009 7480              MOV     A,#080H
000B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 436
000C 900000      R     MOV     DPTR,#USBFS_ep0Mode
000F 740F              MOV     A,#0FH
0011 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 438
0012 900000      R     MOV     DPTR,#USBFS_lastPacketSize
0015 E4                CLR     A
0016 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 439
0017 900000      R     MOV     DPTR,#USBFS_ep0Count
001A E4                CLR     A
001B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 441
001C 7F01              MOV     R7,#01H
                                           ; SOURCE LINE # 442
001E         ?C0052:
001E 22                RET     
             ; FUNCTION USBFS_InitZeroLengthControlTransfer (END)

             ; FUNCTION USBFS_ControlReadDataStage (BEGIN)
                                           ; SOURCE LINE # 462
                                           ; SOURCE LINE # 464
                                           ; SOURCE LINE # 465
0000 120000      R     LCALL   USBFS_LoadEP0
                                           ; SOURCE LINE # 466
0003 22                RET     
             ; FUNCTION USBFS_ControlReadDataStage (END)

             ; FUNCTION USBFS_ControlReadStatusStage (BEGIN)
                                           ; SOURCE LINE # 491
                                           ; SOURCE LINE # 492
                                           ; SOURCE LINE # 494
0000 900000      R     MOV     DPTR,#USBFS_lastPacketSize
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
0005 7E00              MOV     R6,#00H
0007 900000      R     MOV     DPTR,#USBFS_transferByteCount
000A EE                MOV     A,R6
000B 8FF0              MOV     B,R7
000D 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 496
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 27  

0010 900000      R     MOV     DPTR,#USBFS_transferState
0013 E4                CLR     A
0014 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 498
0015 7F01              MOV     R7,#01H
0017 120000      R     LCALL   _USBFS_UpdateStatusBlock
                                           ; SOURCE LINE # 500
001A 900000      R     MOV     DPTR,#USBFS_ep0Mode
001D 7403              MOV     A,#03H
001F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 501
0020 22                RET     
             ; FUNCTION USBFS_ControlReadStatusStage (END)

             ; FUNCTION USBFS_InitControlWrite (BEGIN)
                                           ; SOURCE LINE # 526
                                           ; SOURCE LINE # 527
                                           ; SOURCE LINE # 531
0000 900000      R     MOV     DPTR,#USBFS_transferState
0003 7404              MOV     A,#04H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 533
0006 900000      R     MOV     DPTR,#USBFS_ep0Toggle
0009 7480              MOV     A,#080H
000B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 535
000C 120000      R     LCALL   USBFS_InitializeStatusBlock
                                           ; SOURCE LINE # 537
000F 906007            MOV     DPTR,#06007H
0012 E0                MOVX    A,@DPTR
0013 FF                MOV     R7,A
0014 7E00              MOV     R6,#00H
0016 EF                MOV     A,R7
0017 7F00              MOV     R7,#00H
0019 FE                MOV     R6,A
001A 906006            MOV     DPTR,#06006H
001D E0                MOVX    A,@DPTR
001E FD                MOV     R5,A
001F 7C00              MOV     R4,#00H
0021 EE                MOV     A,R6
0022 4C                ORL     A,R4
0023 FE                MOV     R6,A
0024 EF                MOV     A,R7
0025 4D                ORL     A,R5
0026 FF                MOV     R7,A
0027 900000      R     MOV     DPTR,#xferCount
002A EE                MOV     A,R6
002B F0                MOVX    @DPTR,A
002C A3                INC     DPTR
002D EF                MOV     A,R7
002E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 539
002F 900000      R     MOV     DPTR,#xferCount
0032 E0                MOVX    A,@DPTR
0033 FE                MOV     R6,A
0034 A3                INC     DPTR
0035 E0                MOVX    A,@DPTR
0036 FF                MOV     R7,A
0037 900000      R     MOV     DPTR,#USBFS_currentTD
003A E0                MOVX    A,@DPTR
003B FC                MOV     R4,A
003C A3                INC     DPTR
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 28  

003D E0                MOVX    A,@DPTR
003E FD                MOV     R5,A
003F D3                SETB    C
0040 ED                MOV     A,R5
0041 9F                SUBB    A,R7
0042 EC                MOV     A,R4
0043 9E                SUBB    A,R6
0044 4010              JC      ?C0055
                                           ; SOURCE LINE # 540
                                           ; SOURCE LINE # 541
0046 900000      R     MOV     DPTR,#xferCount
0049 E0                MOVX    A,@DPTR
004A FE                MOV     R6,A
004B A3                INC     DPTR
004C E0                MOVX    A,@DPTR
004D FF                MOV     R7,A
004E 900000      R     MOV     DPTR,#USBFS_currentTD
0051 EE                MOV     A,R6
0052 F0                MOVX    @DPTR,A
0053 A3                INC     DPTR
0054 EF                MOV     A,R7
0055 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 542
0056         ?C0055:
                                           ; SOURCE LINE # 545
0056 900000      R     MOV     DPTR,#USBFS_ep0Mode
0059 740B              MOV     A,#0BH
005B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 547
005C 7F01              MOV     R7,#01H
                                           ; SOURCE LINE # 548
005E         ?C0056:
005E 22                RET     
             ; FUNCTION USBFS_InitControlWrite (END)

             ; FUNCTION USBFS_ControlWriteDataStage (BEGIN)
                                           ; SOURCE LINE # 581
                                           ; SOURCE LINE # 582
                                           ; SOURCE LINE # 584
0000 900000      R     MOV     DPTR,#regIndex
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 586
0005 906029            MOV     DPTR,#06029H
0008 E0                MOVX    A,@DPTR
0009 FF                MOV     R7,A
000A EF                MOV     A,R7
000B 540F              ANL     A,#0FH
000D FF                MOV     R7,A
000E EF                MOV     A,R7
000F 24FE              ADD     A,#0FEH
0011 FF                MOV     R7,A
0012 900000      R     MOV     DPTR,#ep0Count
0015 EF                MOV     A,R7
0016 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 589
0017 900000      R     MOV     DPTR,#ep0Count
001A E0                MOVX    A,@DPTR
001B FF                MOV     R7,A
001C 7E00              MOV     R6,#00H
001E 900000      R     MOV     DPTR,#USBFS_transferByteCount
0021 EE                MOV     A,R6
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 29  

0022 8FF0              MOV     B,R7
0024 120000      E     LCALL   ?C?IILDX
0027         ?C0057:
                                           ; SOURCE LINE # 591
0027 900000      R     MOV     DPTR,#USBFS_currentTD
002A E0                MOVX    A,@DPTR
002B FE                MOV     R6,A
002C A3                INC     DPTR
002D E0                MOVX    A,@DPTR
002E FF                MOV     R7,A
002F D3                SETB    C
0030 EF                MOV     A,R7
0031 9400              SUBB    A,#00H
0033 EE                MOV     A,R6
0034 9400              SUBB    A,#00H
0036 4057              JC      ?C0058
0038 900000      R     MOV     DPTR,#ep0Count
003B E0                MOVX    A,@DPTR
003C FF                MOV     R7,A
003D EF                MOV     A,R7
003E D3                SETB    C
003F 9400              SUBB    A,#00H
0041 404C              JC      ?C0058
                                           ; SOURCE LINE # 592
                                           ; SOURCE LINE # 593
0043 900000      R     MOV     DPTR,#regIndex
0046 E0                MOVX    A,@DPTR
0047 FF                MOV     R7,A
0048 7E00              MOV     R6,#00H
004A EF                MOV     A,R7
004B 2400              ADD     A,#00H
004D FF                MOV     R7,A
004E EE                MOV     A,R6
004F 3460              ADDC    A,#060H
0051 FE                MOV     R6,A
0052 8F82              MOV     DPL,R7
0054 8E83              MOV     DPH,R6
0056 E0                MOVX    A,@DPTR
0057 FF                MOV     R7,A
0058 900000      R     MOV     DPTR,#USBFS_currentTD+02H
005B 120000      E     LCALL   ?C?PLDXDATA
005E EF                MOV     A,R7
005F 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 594
0062 900000      R     MOV     DPTR,#USBFS_currentTD+02H
0065 120000      E     LCALL   ?C?PLDXDATA
0068 E9                MOV     A,R1
0069 2401              ADD     A,#01H
006B F9                MOV     R1,A
006C EA                MOV     A,R2
006D 3400              ADDC    A,#00H
006F FA                MOV     R2,A
0070 900000      R     MOV     DPTR,#USBFS_currentTD+02H
0073 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 595
0076 900000      R     MOV     DPTR,#regIndex
0079 E0                MOVX    A,@DPTR
007A 04                INC     A
007B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 596
007C 900000      R     MOV     DPTR,#ep0Count
007F E0                MOVX    A,@DPTR
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 30  

0080 14                DEC     A
0081 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 597
0082 900000      R     MOV     DPTR,#USBFS_currentTD
0085 74FF              MOV     A,#0FFH
0087 75F0FF            MOV     B,#0FFH
008A 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 598
008D 8098              SJMP    ?C0057
008F         ?C0058:
                                           ; SOURCE LINE # 599
008F 900000      R     MOV     DPTR,#ep0Count
0092 E0                MOVX    A,@DPTR
0093 FF                MOV     R7,A
0094 900000      R     MOV     DPTR,#USBFS_ep0Count
0097 EF                MOV     A,R7
0098 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 601
0099 900000      R     MOV     DPTR,#USBFS_ep0Toggle
009C E0                MOVX    A,@DPTR
009D FF                MOV     R7,A
009E EF                MOV     A,R7
009F 6480              XRL     A,#080H
00A1 FF                MOV     R7,A
00A2 900000      R     MOV     DPTR,#USBFS_ep0Toggle
00A5 EF                MOV     A,R7
00A6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 603
00A7 900000      R     MOV     DPTR,#USBFS_ep0Mode
00AA 740B              MOV     A,#0BH
00AC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 604
00AD 22                RET     
             ; FUNCTION USBFS_ControlWriteDataStage (END)

             ; FUNCTION USBFS_ControlWriteStatusStage (BEGIN)
                                           ; SOURCE LINE # 628
                                           ; SOURCE LINE # 629
                                           ; SOURCE LINE # 631
0000 900000      R     MOV     DPTR,#USBFS_transferState
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 633
0005 7F01              MOV     R7,#01H
0007 120000      R     LCALL   _USBFS_UpdateStatusBlock
                                           ; SOURCE LINE # 635
000A 900000      R     MOV     DPTR,#USBFS_ep0Mode
000D 7403              MOV     A,#03H
000F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 636
0010 22                RET     
             ; FUNCTION USBFS_ControlWriteStatusStage (END)

             ; FUNCTION USBFS_InitNoDataControlTransfer (BEGIN)
                                           ; SOURCE LINE # 662
                                           ; SOURCE LINE # 663
                                           ; SOURCE LINE # 664
0000 900000      R     MOV     DPTR,#USBFS_transferState
0003 7406              MOV     A,#06H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 665
0006 900000      R     MOV     DPTR,#USBFS_ep0Mode
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 31  

0009 7406              MOV     A,#06H
000B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 666
000C 900000      R     MOV     DPTR,#USBFS_ep0Toggle
000F 7480              MOV     A,#080H
0011 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 667
0012 900000      R     MOV     DPTR,#USBFS_ep0Count
0015 E4                CLR     A
0016 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 669
0017 7F01              MOV     R7,#01H
                                           ; SOURCE LINE # 670
0019         ?C0061:
0019 22                RET     
             ; FUNCTION USBFS_InitNoDataControlTransfer (END)

             ; FUNCTION USBFS_NoDataControlStatusStage (BEGIN)
                                           ; SOURCE LINE # 698
                                           ; SOURCE LINE # 699
                                           ; SOURCE LINE # 701
0000 900000      R     MOV     DPTR,#USBFS_deviceAddress
0003 E0                MOVX    A,@DPTR
0004 FF                MOV     R7,A
0005 EF                MOV     A,R7
0006 6013              JZ      ?C0062
                                           ; SOURCE LINE # 702
                                           ; SOURCE LINE # 703
0008 900000      R     MOV     DPTR,#USBFS_deviceAddress
000B E0                MOVX    A,@DPTR
000C FF                MOV     R7,A
000D EF                MOV     A,R7
000E 4480              ORL     A,#080H
0010 FF                MOV     R7,A
0011 906008            MOV     DPTR,#06008H
0014 EF                MOV     A,R7
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 704
0016 900000      R     MOV     DPTR,#USBFS_deviceAddress
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 705
001B         ?C0062:
                                           ; SOURCE LINE # 707
001B 900000      R     MOV     DPTR,#USBFS_transferState
001E E4                CLR     A
001F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 709
0020 7F01              MOV     R7,#01H
0022 120000      R     LCALL   _USBFS_UpdateStatusBlock
                                           ; SOURCE LINE # 711
0025 900000      R     MOV     DPTR,#USBFS_ep0Mode
0028 7403              MOV     A,#03H
002A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 712
002B 22                RET     
             ; FUNCTION USBFS_NoDataControlStatusStage (END)

             ; FUNCTION _USBFS_UpdateStatusBlock (BEGIN)
                                           ; SOURCE LINE # 740
0000 900000      R     MOV     DPTR,#completionCode
0003 EF                MOV     A,R7
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 32  

0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 741
                                           ; SOURCE LINE # 742
0005 7B00              MOV     R3,#00H
0007 7A00              MOV     R2,#00H
0009 7900              MOV     R1,#00H
000B C003              PUSH    AR3
000D C002              PUSH    AR2
000F C001              PUSH    AR1
0011 900000      R     MOV     DPTR,#USBFS_currentTD+05H
0014 120000      E     LCALL   ?C?PLDXDATA
0017 D082              POP     DPL
0019 D083              POP     DPH
001B D0E0              POP     ACC
001D 6B                XRL     A,R3
001E 7008              JNZ     ?C0068
0020 E9                MOV     A,R1
0021 6582              XRL     A,DPL
0023 7003              JNZ     ?C0068
0025 EA                MOV     A,R2
0026 6583              XRL     A,DPH
0028         ?C0068:
0028 6037              JZ      ?C0065
                                           ; SOURCE LINE # 743
                                           ; SOURCE LINE # 744
002A 900000      R     MOV     DPTR,#completionCode
002D E0                MOVX    A,@DPTR
002E FF                MOV     R7,A
002F 900000      R     MOV     DPTR,#USBFS_currentTD+05H
0032 120000      E     LCALL   ?C?PLDXDATA
0035 EF                MOV     A,R7
0036 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 745
0039 900000      R     MOV     DPTR,#USBFS_transferByteCount
003C E0                MOVX    A,@DPTR
003D FE                MOV     R6,A
003E A3                INC     DPTR
003F E0                MOVX    A,@DPTR
0040 FF                MOV     R7,A
0041 900000      R     MOV     DPTR,#USBFS_currentTD+05H
0044 120000      E     LCALL   ?C?PLDXDATA
0047 E9                MOV     A,R1
0048 2401              ADD     A,#01H
004A F9                MOV     R1,A
004B EA                MOV     A,R2
004C 3400              ADDC    A,#00H
004E FA                MOV     R2,A
004F EE                MOV     A,R6
0050 8FF0              MOV     B,R7
0052 120000      E     LCALL   ?C?ISTPTR
                                           ; SOURCE LINE # 746
0055 7B00              MOV     R3,#00H
0057 7A00              MOV     R2,#00H
0059 7900              MOV     R1,#00H
005B 900000      R     MOV     DPTR,#USBFS_currentTD+05H
005E 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 747
                                           ; SOURCE LINE # 748
0061         ?C0065:
0061 22                RET     
             ; FUNCTION _USBFS_UpdateStatusBlock (END)

C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 33  

             ; FUNCTION USBFS_InitializeStatusBlock (BEGIN)
                                           ; SOURCE LINE # 777
                                           ; SOURCE LINE # 778
                                           ; SOURCE LINE # 779
0000 900000      R     MOV     DPTR,#USBFS_transferByteCount
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 E4                CLR     A
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 780
0008 7B00              MOV     R3,#00H
000A 7A00              MOV     R2,#00H
000C 7900              MOV     R1,#00H
000E C003              PUSH    AR3
0010 C002              PUSH    AR2
0012 C001              PUSH    AR1
0014 900000      R     MOV     DPTR,#USBFS_currentTD+05H
0017 120000      E     LCALL   ?C?PLDXDATA
001A D082              POP     DPL
001C D083              POP     DPH
001E D0E0              POP     ACC
0020 6B                XRL     A,R3
0021 7008              JNZ     ?C0069
0023 E9                MOV     A,R1
0024 6582              XRL     A,DPL
0026 7003              JNZ     ?C0069
0028 EA                MOV     A,R2
0029 6583              XRL     A,DPH
002B         ?C0069:
002B 601F              JZ      ?C0067
                                           ; SOURCE LINE # 781
                                           ; SOURCE LINE # 782
002D 900000      R     MOV     DPTR,#USBFS_currentTD+05H
0030 120000      E     LCALL   ?C?PLDXDATA
0033 E4                CLR     A
0034 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 783
0037 900000      R     MOV     DPTR,#USBFS_currentTD+05H
003A 120000      E     LCALL   ?C?PLDXDATA
003D E9                MOV     A,R1
003E 2401              ADD     A,#01H
0040 F9                MOV     R1,A
0041 EA                MOV     A,R2
0042 3400              ADDC    A,#00H
0044 FA                MOV     R2,A
0045 E4                CLR     A
0046 75F000            MOV     B,#00H
0049 120000      E     LCALL   ?C?ISTPTR
                                           ; SOURCE LINE # 784
                                           ; SOURCE LINE # 785
004C         ?C0067:
004C 22                RET     
             ; FUNCTION USBFS_InitializeStatusBlock (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1498    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    125      11
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.51   USBFS_DRV                                                             10/03/2016 19:53:27 PAGE 34  

   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
